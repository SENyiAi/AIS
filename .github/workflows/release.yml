name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $version = "${{ github.ref_name }}"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Download Real-CUGAN
      shell: pwsh
      run: |
        $url = "https://github.com/nihui/realcugan-ncnn-vulkan/releases/download/20220728/realcugan-ncnn-vulkan-20220728-windows.zip"
        Invoke-WebRequest -Uri $url -OutFile "realcugan.zip"
        Expand-Archive -Path "realcugan.zip" -DestinationPath "æ¨¡å‹/"
        Remove-Item "realcugan.zip"
    
    - name: Download Real-ESRGAN
      shell: pwsh
      run: |
        $url = "https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesrgan-ncnn-vulkan-20220424-windows.zip"
        Invoke-WebRequest -Uri $url -OutFile "realesrgan.zip"
        Expand-Archive -Path "realesrgan.zip" -DestinationPath "æ¨¡å‹/"
        Remove-Item "realesrgan.zip"
    
    - name: Download Waifu2x
      shell: pwsh
      run: |
        $url = "https://github.com/nihui/waifu2x-ncnn-vulkan/releases/download/20250915/waifu2x-ncnn-vulkan-20250915-windows.zip"
        Invoke-WebRequest -Uri $url -OutFile "waifu2x.zip"
        Expand-Archive -Path "waifu2x.zip" -DestinationPath "æ¨¡å‹/"
        Remove-Item "waifu2x.zip"
    
    - name: Setup Python for pip
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Download Python Embed and install Gradio
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "å‰ç½®"
        
        # ä¸‹è½½ Python 3.14 åµŒå…¥ç‰ˆ
        $url = "https://www.python.org/ftp/python/3.14.0/python-3.14.0-embed-amd64.zip"
        Invoke-WebRequest -Uri $url -OutFile "python-embed.zip"
        Expand-Archive -Path "python-embed.zip" -DestinationPath "å‰ç½®/python-3.14.0-embed-amd64"
        Remove-Item "python-embed.zip"
        
        # ä¿®æ”¹ pth æ–‡ä»¶ä»¥æ”¯æŒ site-packages
        $pthFile = "å‰ç½®/python-3.14.0-embed-amd64/python314._pth"
        $content = Get-Content $pthFile
        $content = $content -replace '#import site', 'import site'
        $content | Set-Content $pthFile
        Add-Content $pthFile "Lib/site-packages"
        
        # ä¸‹è½½ get-pip.py
        Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "å‰ç½®/python-3.14.0-embed-amd64/get-pip.py"
        
        # å®‰è£… pip
        & "å‰ç½®/python-3.14.0-embed-amd64/python.exe" "å‰ç½®/python-3.14.0-embed-amd64/get-pip.py" --no-warn-script-location
        
        # åˆ›å»º site-packages ç›®å½•
        New-Item -ItemType Directory -Force -Path "å‰ç½®/python-3.14.0-embed-amd64/Lib/site-packages"
        
        # å®‰è£… Gradio å’Œä¾èµ–åˆ° site-packages
        & "å‰ç½®/python-3.14.0-embed-amd64/python.exe" -m pip install gradio pillow --target "å‰ç½®/python-3.14.0-embed-amd64/Lib/site-packages" --no-warn-script-location
        
        # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
        Remove-Item "å‰ç½®/python-3.14.0-embed-amd64/get-pip.py" -ErrorAction SilentlyContinue
    
    - name: Create Lite package (without Python)
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $packageName = "AIS-$version-Lite"
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path $packageName
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
        Copy-Item "AIS.py" -Destination $packageName
        Copy-Item "AIS_WebUI.py" -Destination $packageName
        Copy-Item "i18n.py" -Destination $packageName
        Copy-Item "requirements.txt" -Destination $packageName
        Copy-Item "å¯åŠ¨.bat" -Destination $packageName
        Copy-Item "README.md" -Destination $packageName -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" -Destination $packageName -ErrorAction SilentlyContinue
        
        # å¤åˆ¶æ¨¡å‹
        Copy-Item -Path "æ¨¡å‹" -Destination $packageName -Recurse
        
        # åˆ›å»ºå¿…è¦çš„ç©ºç›®å½•
        New-Item -ItemType Directory -Force -Path "$packageName/è¾“å‡º"
        New-Item -ItemType Directory -Force -Path "$packageName/æ•°æ®"
        
        # å‹ç¼©
        Compress-Archive -Path $packageName -DestinationPath "$packageName.zip" -Force
    
    - name: Create Full package (with Python + Gradio)
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $packageName = "AIS-$version-Full"
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path $packageName
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
        Copy-Item "AIS.py" -Destination $packageName
        Copy-Item "AIS_WebUI.py" -Destination $packageName
        Copy-Item "i18n.py" -Destination $packageName
        Copy-Item "requirements.txt" -Destination $packageName
        Copy-Item "å¯åŠ¨.bat" -Destination $packageName
        Copy-Item "README.md" -Destination $packageName -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" -Destination $packageName -ErrorAction SilentlyContinue
        
        # å¤åˆ¶æ¨¡å‹å’Œå‰ç½®ï¼ˆåŒ…å«Pythonå’ŒGradioï¼‰
        Copy-Item -Path "æ¨¡å‹" -Destination $packageName -Recurse
        Copy-Item -Path "å‰ç½®" -Destination $packageName -Recurse
        
        # åˆ›å»ºå¿…è¦çš„ç©ºç›®å½•
        New-Item -ItemType Directory -Force -Path "$packageName/è¾“å‡º"
        New-Item -ItemType Directory -Force -Path "$packageName/æ•°æ®"
        
        # å‹ç¼©
        Compress-Archive -Path $packageName -DestinationPath "$packageName.zip" -Force
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: AIS ${{ steps.version.outputs.VERSION }}
        tag_name: ${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: false
        files: |
          AIS-${{ steps.version.outputs.VERSION }}-Full.zip
          AIS-${{ steps.version.outputs.VERSION }}-Lite.zip
        body: |
          ## AIS å›¾åƒè¶…åˆ†è¾¨ç‡å·¥å…· ${{ steps.version.outputs.VERSION }}
          
          ### ğŸ“¦ ä¸‹è½½ç‰ˆæœ¬è¯´æ˜
          
          | ç‰ˆæœ¬ | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|------|
          | **å®Œæ•´ç‰ˆ (æ¨è)** | `AIS-${{ steps.version.outputs.VERSION }}-Full.zip` | å†…ç½® Python 3.12 + Gradioï¼Œå¼€ç®±å³ç”¨ |
          | **ç²¾ç®€ç‰ˆ** | `AIS-${{ steps.version.outputs.VERSION }}-Lite.zip` | éœ€è‡ªè¡Œå®‰è£… Python 3.10+ å’Œä¾èµ– |
          
          ### ğŸ¯ åŒ…å«å¼•æ“
          - **Real-CUGAN** - åŠ¨æ¼«å›¾åƒè¶…åˆ†ï¼Œç»†èŠ‚ä¿ç•™å‡ºè‰²
          - **Real-ESRGAN** - é€šç”¨å›¾åƒè¶…åˆ†ï¼Œæ•ˆæœç¨³å®š
          - **Waifu2x** - ç»å…¸åŠ¨æ¼«è¶…åˆ†ï¼Œé€Ÿåº¦å¿«
          
          ---
          
          ### ğŸš€ å®Œæ•´ç‰ˆä½¿ç”¨æ–¹æ³•
          1. è§£å‹ç¼©åˆ°ä»»æ„ç›®å½•ï¼ˆè·¯å¾„ä¸è¦æœ‰ä¸­æ–‡ï¼‰
          2. åŒå‡» `å¯åŠ¨.bat` è¿è¡Œ
          3. æµè§ˆå™¨è®¿é—® http://127.0.0.1:7860
          
          ### ğŸ”§ ç²¾ç®€ç‰ˆä½¿ç”¨æ–¹æ³•
          1. ç¡®ä¿å·²å®‰è£… Python 3.10 æˆ–æ›´é«˜ç‰ˆæœ¬
          2. è§£å‹ç¼©åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `pip install -r requirements.txt` å®‰è£…ä¾èµ–
          4. åŒå‡» `å¯åŠ¨.bat` è¿è¡Œ
          
          ---
          
          ### âš ï¸ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 x64
          - æ”¯æŒ Vulkan çš„æ˜¾å¡ (NVIDIA/AMD/Intel)
          - å®Œæ•´ç‰ˆçº¦ 500MBï¼Œç²¾ç®€ç‰ˆçº¦ 100MB
          
          ### ğŸŒ è¯­è¨€æ”¯æŒ
          - ç®€ä½“ä¸­æ–‡
          - English
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
