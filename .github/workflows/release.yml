name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

# 添加权限声明解决403错误
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $version = "${{ github.ref_name }}"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Install 7-Zip
      shell: pwsh
      run: |
        # Windows Runner 已预装 7-Zip，验证安装
        $7zPath = "C:\Program Files\7-Zip\7z.exe"
        if (Test-Path $7zPath) {
            echo "7-Zip found at: $7zPath"
            & $7zPath --help | Select-Object -First 5
        } else {
            echo "Installing 7-Zip..."
            choco install 7zip -y
        }
    
    - name: Download Real-CUGAN
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "模型"
        $url = "https://github.com/nihui/realcugan-ncnn-vulkan/releases/download/20220728/realcugan-ncnn-vulkan-20220728-windows.zip"
        Invoke-WebRequest -Uri $url -OutFile "realcugan.zip"
        Expand-Archive -Path "realcugan.zip" -DestinationPath "temp_cugan"
        Move-Item "temp_cugan/*" "模型/realcugan-ncnn-vulkan-20220728-windows" -ErrorAction SilentlyContinue
        if (-not (Test-Path "模型/realcugan-ncnn-vulkan-20220728-windows")) {
            Move-Item "temp_cugan/realcugan-ncnn-vulkan-20220728-windows" "模型/" -ErrorAction SilentlyContinue
        }
        Remove-Item "realcugan.zip" -ErrorAction SilentlyContinue
        Remove-Item "temp_cugan" -Recurse -ErrorAction SilentlyContinue
    
    - name: Download Real-ESRGAN
      shell: pwsh
      run: |
        $url = "https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesrgan-ncnn-vulkan-20220424-windows.zip"
        Invoke-WebRequest -Uri $url -OutFile "realesrgan.zip"
        Expand-Archive -Path "realesrgan.zip" -DestinationPath "temp_esrgan"
        Move-Item "temp_esrgan/*" "模型/realesrgan-ncnn-vulkan-20220424-windows" -ErrorAction SilentlyContinue
        if (-not (Test-Path "模型/realesrgan-ncnn-vulkan-20220424-windows")) {
            Move-Item "temp_esrgan/realesrgan-ncnn-vulkan-20220424-windows" "模型/" -ErrorAction SilentlyContinue
        }
        Remove-Item "realesrgan.zip" -ErrorAction SilentlyContinue
        Remove-Item "temp_esrgan" -Recurse -ErrorAction SilentlyContinue
    
    - name: Download Waifu2x
      shell: pwsh
      run: |
        $url = "https://github.com/nihui/waifu2x-ncnn-vulkan/releases/download/20250915/waifu2x-ncnn-vulkan-20250915-windows.zip"
        Invoke-WebRequest -Uri $url -OutFile "waifu2x.zip"
        Expand-Archive -Path "waifu2x.zip" -DestinationPath "temp_waifu2x"
        Move-Item "temp_waifu2x/*" "模型/waifu2x-ncnn-vulkan-20250915-windows" -ErrorAction SilentlyContinue
        if (-not (Test-Path "模型/waifu2x-ncnn-vulkan-20250915-windows")) {
            Move-Item "temp_waifu2x/waifu2x-ncnn-vulkan-20250915-windows" "模型/" -ErrorAction SilentlyContinue
        }
        Remove-Item "waifu2x.zip" -ErrorAction SilentlyContinue
        Remove-Item "temp_waifu2x" -Recurse -ErrorAction SilentlyContinue
    
    - name: Download Anime4KCPP
      shell: pwsh
      run: |
        $url = "https://github.com/TianZerL/Anime4KCPP/releases/download/v3.0.0/Anime4KCPP-CLI-v3.0.0-x64-MSVC.7z"
        Invoke-WebRequest -Uri $url -OutFile "anime4k.7z"
        # 使用 7-Zip 解压
        $7zPath = "C:\Program Files\7-Zip\7z.exe"
        & $7zPath x "anime4k.7z" -o"temp_anime4k" -y
        # 检查解压后的结构
        $innerDir = Get-ChildItem -Path "temp_anime4k" -Directory | Select-Object -First 1
        if ($innerDir) {
            Move-Item "$($innerDir.FullName)" "模型/Anime4KCPP-CLI-v3.0.0-x64-MSVC" -ErrorAction SilentlyContinue
        } else {
            # 如果没有嵌套目录，直接移动
            New-Item -ItemType Directory -Force -Path "模型/Anime4KCPP-CLI-v3.0.0-x64-MSVC"
            Move-Item "temp_anime4k/*" "模型/Anime4KCPP-CLI-v3.0.0-x64-MSVC/" -ErrorAction SilentlyContinue
        }
        Remove-Item "anime4k.7z" -ErrorAction SilentlyContinue
        Remove-Item "temp_anime4k" -Recurse -ErrorAction SilentlyContinue
        echo "Anime4KCPP downloaded to: 模型/Anime4KCPP-CLI-v3.0.0-x64-MSVC"
        Get-ChildItem "模型/Anime4KCPP-CLI-v3.0.0-x64-MSVC" | ForEach-Object { Write-Host $_.Name }
    
    - name: Download FFmpeg
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "前置"
        $url = "https://www.gyan.dev/ffmpeg/builds/packages/ffmpeg-8.0.1-essentials_build.7z"
        $7zPath = "C:\Program Files\7-Zip\7z.exe"
        Invoke-WebRequest -Uri $url -OutFile "ffmpeg.7z"
        # 使用 7-Zip 解压
        & $7zPath x "ffmpeg.7z" -o"temp_ffmpeg" -y
        # FFmpeg 解压后有一个嵌套目录，需要重命名
        $innerDir = Get-ChildItem -Path "temp_ffmpeg" -Directory | Select-Object -First 1
        if ($innerDir) {
            Move-Item "$($innerDir.FullName)" "前置/ffmpeg-8.0.1-essentials_build" -ErrorAction SilentlyContinue
        }
        Remove-Item "ffmpeg.7z" -ErrorAction SilentlyContinue
        Remove-Item "temp_ffmpeg" -Recurse -ErrorAction SilentlyContinue
        # 显示下载的 FFmpeg 信息
        echo "FFmpeg downloaded to: 前置/ffmpeg-8.0.1-essentials_build"
        Get-ChildItem "前置/ffmpeg-8.0.1-essentials_build/bin" -ErrorAction SilentlyContinue | ForEach-Object { 
          Write-Host "$($_.Name) - $([math]::Round($_.Length / 1MB, 2)) MB" 
        }
    
    - name: Verify model directories
      shell: pwsh
      run: |
        echo "=== 验证模型目录结构 ==="
        Get-ChildItem -Path "模型" -Recurse -Depth 1 | ForEach-Object { Write-Host $_.FullName }
        
        $cugan = Test-Path "模型/realcugan-ncnn-vulkan-20220728-windows/realcugan-ncnn-vulkan.exe"
        $esrgan = Test-Path "模型/realesrgan-ncnn-vulkan-20220424-windows/realesrgan-ncnn-vulkan.exe"
        $waifu2x = Test-Path "模型/waifu2x-ncnn-vulkan-20250915-windows/waifu2x-ncnn-vulkan.exe"
        $anime4k = Test-Path "模型/Anime4KCPP-CLI-v3.0.0-x64-MSVC/ac_cli.exe"
        $ffmpeg = Test-Path "前置/ffmpeg-8.0.1-essentials_build/bin/ffmpeg.exe"
        
        echo "CUGAN exe exists: $cugan"
        echo "ESRGAN exe exists: $esrgan"
        echo "WAIFU2X exe exists: $waifu2x"
        echo "ANIME4K exe exists: $anime4k"
        echo "FFMPEG exe exists: $ffmpeg"
        
        if (-not ($cugan -and $esrgan -and $waifu2x -and $anime4k -and $ffmpeg)) {
            echo "警告: 部分模型或工具文件未找到"
            echo "=== 模型目录 ==="
            Get-ChildItem -Path "模型" -Recurse | ForEach-Object { Write-Host $_.FullName }
            echo "=== 前置目录 ==="
            Get-ChildItem -Path "前置" -Recurse -Depth 2 | ForEach-Object { Write-Host $_.FullName }
        }
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Download Python Embed and install Gradio
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "前置"
        
        # 下载 Python 3.12.10 嵌入版 (稳定版，兼容性好)
        $url = "https://www.python.org/ftp/python/3.12.10/python-3.12.10-embed-amd64.zip"
        Invoke-WebRequest -Uri $url -OutFile "python-embed.zip"
        Expand-Archive -Path "python-embed.zip" -DestinationPath "前置/python-3.12.10-embed-amd64"
        Remove-Item "python-embed.zip"
        
        # 修改 pth 文件以支持 site-packages
        $pthFile = "前置/python-3.12.10-embed-amd64/python312._pth"
        Set-Content -Path $pthFile -Value "python312.zip`n.`nLib/site-packages`nimport site" -Encoding UTF8
        
        # 创建目录结构
        New-Item -ItemType Directory -Force -Path "前置/python-3.12.10-embed-amd64/Lib/site-packages"
        New-Item -ItemType Directory -Force -Path "前置/python-3.12.10-embed-amd64/Scripts"
        
        # 下载并安装 pip
        Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "前置/python-3.12.10-embed-amd64/get-pip.py"
        & "前置/python-3.12.10-embed-amd64/python.exe" "前置/python-3.12.10-embed-amd64/get-pip.py" --no-warn-script-location
        
        # 验证 pip 安装
        & "前置/python-3.12.10-embed-amd64/python.exe" -m pip --version
        
        # 安装 Gradio 和依赖（直接安装到 site-packages）
        & "前置/python-3.12.10-embed-amd64/python.exe" -m pip install gradio pillow --no-warn-script-location
        
        # 验证安装
        echo "=== Python 环境验证 ==="
        & "前置/python-3.12.10-embed-amd64/python.exe" --version
        & "前置/python-3.12.10-embed-amd64/python.exe" -c "import gradio; print(f'Gradio version: {gradio.__version__}')"
        & "前置/python-3.12.10-embed-amd64/python.exe" -c "import numpy; print(f'NumPy version: {numpy.__version__}')"
        
        # 显示 pth 文件内容
        echo "=== python312._pth 内容 ==="
        Get-Content $pthFile
    
    - name: Verify source files exist
      shell: pwsh
      run: |
        echo "=== 验证源文件 ==="
        $requiredFiles = @("AIS.py", "AIS_WebUI.py", "i18n.py", "requirements.txt", "启动.bat")
        foreach ($file in $requiredFiles) {
          if (Test-Path $file) {
            echo "✓ $file exists"
          } else {
            echo "✗ $file NOT FOUND!"
            exit 1
          }
        }
        echo "=== 所有必需文件已确认 ==="
    
    - name: Create Lite package
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $packageName = "AIS-$version-Lite"
        $7zPath = "C:\Program Files\7-Zip\7z.exe"
        
        New-Item -ItemType Directory -Force -Path $packageName
        
        # 复制核心文件并验证
        $coreFiles = @("AIS.py", "AIS_WebUI.py", "i18n.py", "requirements.txt", "启动.bat")
        foreach ($file in $coreFiles) {
          Copy-Item $file -Destination $packageName -ErrorAction Stop
          echo "Copied: $file"
        }
        
        # 复制可选文件
        Copy-Item "README.md" -Destination $packageName -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" -Destination $packageName -ErrorAction SilentlyContinue
        
        Copy-Item -Path "模型" -Destination $packageName -Recurse
        
        New-Item -ItemType Directory -Force -Path "$packageName/输出"
        New-Item -ItemType Directory -Force -Path "$packageName/数据"
        
        # 验证打包内容
        echo "=== Lite package contents ==="
        Get-ChildItem -Path $packageName -Recurse -Depth 1 | ForEach-Object { Write-Host $_.FullName }
        
        # 使用 7-Zip 打包 (mx=9 最高压缩率)
        & $7zPath a -t7z -mx=9 "$packageName.7z" $packageName
        echo "Created: $packageName.7z"
    
    - name: Create Full package
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $packageName = "AIS-$version-Full"
        $7zPath = "C:\Program Files\7-Zip\7z.exe"
        
        New-Item -ItemType Directory -Force -Path $packageName
        
        # 复制核心文件并验证
        $coreFiles = @("AIS.py", "AIS_WebUI.py", "i18n.py", "requirements.txt", "启动.bat")
        foreach ($file in $coreFiles) {
          Copy-Item $file -Destination $packageName -ErrorAction Stop
          echo "Copied: $file"
        }
        
        # 复制可选文件
        Copy-Item "README.md" -Destination $packageName -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" -Destination $packageName -ErrorAction SilentlyContinue
        
        Copy-Item -Path "模型" -Destination $packageName -Recurse
        Copy-Item -Path "前置" -Destination $packageName -Recurse
        
        New-Item -ItemType Directory -Force -Path "$packageName/输出"
        New-Item -ItemType Directory -Force -Path "$packageName/数据"
        
        # 验证打包内容
        echo "=== Full package contents ==="
        Get-ChildItem -Path $packageName -Recurse -Depth 1 | ForEach-Object { Write-Host $_.FullName }
        
        # 确认 i18n.py 存在
        if (-not (Test-Path "$packageName/i18n.py")) {
          echo "ERROR: i18n.py not found in package!"
          exit 1
        }
        
        # 使用 7-Zip 打包 (mx=9 最高压缩率)
        & $7zPath a -t7z -mx=9 "$packageName.7z" $packageName
        echo "Created: $packageName.7z"
    
    - name: List and verify 7z files
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        echo "=== 验证打包文件 ==="
        Get-ChildItem -Path "." -Filter "*.7z" | ForEach-Object { 
          Write-Host "$($_.Name) - $([math]::Round($_.Length / 1MB, 2)) MB"
        }
        
        $full7z = "AIS-$version-Full.7z"
        $lite7z = "AIS-$version-Lite.7z"
        
        if (-not (Test-Path $full7z)) {
          Write-Error "Full package not found: $full7z"
          exit 1
        }
        if (-not (Test-Path $lite7z)) {
          Write-Error "Lite package not found: $lite7z"
          exit 1
        }
        
        echo "Both packages verified successfully!"
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: AIS ${{ steps.version.outputs.VERSION }}
        tag_name: ${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: false
        files: |
          AIS-${{ steps.version.outputs.VERSION }}-Full.7z
          AIS-${{ steps.version.outputs.VERSION }}-Lite.7z
        body: |
          ## AIS 图像超分辨率工具 ${{ steps.version.outputs.VERSION }}
          
          ### 📦 下载版本说明
          
          | 版本 | 文件 | 说明 |
          |------|------|------|
          | **完整版 (推荐)** | `AIS-${{ steps.version.outputs.VERSION }}-Full.7z` | 内置 Python 3.12 + Gradio + FFmpeg，开箱即用 |
          | **精简版** | `AIS-${{ steps.version.outputs.VERSION }}-Lite.7z` | 需自行安装 Python 3.10+ 和依赖 |
          
          > 📌 使用 [7-Zip](https://7-zip.org/) 解压可获得更好的兼容性
          
          ### 🎯 包含引擎
          - **Real-CUGAN** - 动漫图像超分，细节保留出色
          - **Real-ESRGAN** - 通用图像超分，效果稳定
          - **Waifu2x** - 经典动漫超分，速度快
          - **Anime4KCPP** - 快速动漫超分，适合视频和动图
          
          ### 🛠️ 内置工具
          - **FFmpeg** - 用于高质量 GIF/WebP 动图处理
          
          ---
          
          ### 🚀 完整版使用方法
          1. 解压缩到任意目录（路径不要有中文）
          2. 双击 `启动.bat` 运行
          3. 浏览器访问 http://127.0.0.1:7860
          
          ### 🔧 精简版使用方法
          1. 确保已安装 Python 3.10 或更高版本
          2. 解压缩到任意目录
          3. 运行 `pip install -r requirements.txt` 安装依赖
          4. 双击 `启动.bat` 运行
          
          ---
          
          ### ⚠️ 系统要求
          - Windows 10/11 x64
          - 支持 Vulkan 的显卡 (NVIDIA/AMD/Intel)
          
          ### 🌐 语言支持
          - 简体中文 / English
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
