name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

# æ·»åŠ æƒé™å£°æ˜è§£å†³403é”™è¯¯
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $version = "${{ github.ref_name }}"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Download Real-CUGAN
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "æ¨¡å‹"
        $url = "https://github.com/nihui/realcugan-ncnn-vulkan/releases/download/20220728/realcugan-ncnn-vulkan-20220728-windows.zip"
        Invoke-WebRequest -Uri $url -OutFile "realcugan.zip"
        Expand-Archive -Path "realcugan.zip" -DestinationPath "temp_cugan"
        Move-Item "temp_cugan/*" "æ¨¡å‹/realcugan-ncnn-vulkan-20220728-windows" -ErrorAction SilentlyContinue
        if (-not (Test-Path "æ¨¡å‹/realcugan-ncnn-vulkan-20220728-windows")) {
            Move-Item "temp_cugan/realcugan-ncnn-vulkan-20220728-windows" "æ¨¡å‹/" -ErrorAction SilentlyContinue
        }
        Remove-Item "realcugan.zip" -ErrorAction SilentlyContinue
        Remove-Item "temp_cugan" -Recurse -ErrorAction SilentlyContinue
    
    - name: Download Real-ESRGAN
      shell: pwsh
      run: |
        $url = "https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesrgan-ncnn-vulkan-20220424-windows.zip"
        Invoke-WebRequest -Uri $url -OutFile "realesrgan.zip"
        Expand-Archive -Path "realesrgan.zip" -DestinationPath "temp_esrgan"
        Move-Item "temp_esrgan/*" "æ¨¡å‹/realesrgan-ncnn-vulkan-20220424-windows" -ErrorAction SilentlyContinue
        if (-not (Test-Path "æ¨¡å‹/realesrgan-ncnn-vulkan-20220424-windows")) {
            Move-Item "temp_esrgan/realesrgan-ncnn-vulkan-20220424-windows" "æ¨¡å‹/" -ErrorAction SilentlyContinue
        }
        Remove-Item "realesrgan.zip" -ErrorAction SilentlyContinue
        Remove-Item "temp_esrgan" -Recurse -ErrorAction SilentlyContinue
    
    - name: Download Waifu2x
      shell: pwsh
      run: |
        $url = "https://github.com/nihui/waifu2x-ncnn-vulkan/releases/download/20250915/waifu2x-ncnn-vulkan-20250915-windows.zip"
        Invoke-WebRequest -Uri $url -OutFile "waifu2x.zip"
        Expand-Archive -Path "waifu2x.zip" -DestinationPath "temp_waifu2x"
        Move-Item "temp_waifu2x/*" "æ¨¡å‹/waifu2x-ncnn-vulkan-20250915-windows" -ErrorAction SilentlyContinue
        if (-not (Test-Path "æ¨¡å‹/waifu2x-ncnn-vulkan-20250915-windows")) {
            Move-Item "temp_waifu2x/waifu2x-ncnn-vulkan-20250915-windows" "æ¨¡å‹/" -ErrorAction SilentlyContinue
        }
        Remove-Item "waifu2x.zip" -ErrorAction SilentlyContinue
        Remove-Item "temp_waifu2x" -Recurse -ErrorAction SilentlyContinue
    
    - name: Verify model directories
      shell: pwsh
      run: |
        echo "=== éªŒè¯æ¨¡å‹ç›®å½•ç»“æ„ ==="
        Get-ChildItem -Path "æ¨¡å‹" -Recurse -Depth 1 | ForEach-Object { Write-Host $_.FullName }
        
        $cugan = Test-Path "æ¨¡å‹/realcugan-ncnn-vulkan-20220728-windows/realcugan-ncnn-vulkan.exe"
        $esrgan = Test-Path "æ¨¡å‹/realesrgan-ncnn-vulkan-20220424-windows/realesrgan-ncnn-vulkan.exe"
        $waifu2x = Test-Path "æ¨¡å‹/waifu2x-ncnn-vulkan-20250915-windows/waifu2x-ncnn-vulkan.exe"
        
        echo "CUGAN exe exists: $cugan"
        echo "ESRGAN exe exists: $esrgan"
        echo "WAIFU2X exe exists: $waifu2x"
        
        if (-not ($cugan -and $esrgan -and $waifu2x)) {
            echo "è­¦å‘Š: éƒ¨åˆ†æ¨¡å‹æ–‡ä»¶æœªæ‰¾åˆ°"
            Get-ChildItem -Path "æ¨¡å‹" -Recurse | ForEach-Object { Write-Host $_.FullName }
        }
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Download Python Embed and install Gradio
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "å‰ç½®"
        
        # ä¸‹è½½ Python 3.12.10 åµŒå…¥ç‰ˆ (ç¨³å®šç‰ˆï¼Œå…¼å®¹æ€§å¥½)
        $url = "https://www.python.org/ftp/python/3.12.10/python-3.12.10-embed-amd64.zip"
        Invoke-WebRequest -Uri $url -OutFile "python-embed.zip"
        Expand-Archive -Path "python-embed.zip" -DestinationPath "å‰ç½®/python-3.12.10-embed-amd64"
        Remove-Item "python-embed.zip"
        
        # ä¿®æ”¹ pth æ–‡ä»¶ä»¥æ”¯æŒ site-packages
        $pthFile = "å‰ç½®/python-3.12.10-embed-amd64/python312._pth"
        $pthContent = @"
python312.zip
.
Lib/site-packages
import site
"@
        $pthContent | Set-Content $pthFile -Encoding UTF8
        
        # åˆ›å»ºç›®å½•ç»“æ„
        New-Item -ItemType Directory -Force -Path "å‰ç½®/python-3.12.10-embed-amd64/Lib/site-packages"
        New-Item -ItemType Directory -Force -Path "å‰ç½®/python-3.12.10-embed-amd64/Scripts"
        
        # ä¸‹è½½å¹¶å®‰è£… pip
        Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "å‰ç½®/python-3.12.10-embed-amd64/get-pip.py"
        & "å‰ç½®/python-3.12.10-embed-amd64/python.exe" "å‰ç½®/python-3.12.10-embed-amd64/get-pip.py" --no-warn-script-location
        
        # éªŒè¯ pip å®‰è£…
        & "å‰ç½®/python-3.12.10-embed-amd64/python.exe" -m pip --version
        
        # å®‰è£… Gradio å’Œä¾èµ–ï¼ˆç›´æ¥å®‰è£…åˆ° site-packagesï¼‰
        & "å‰ç½®/python-3.12.10-embed-amd64/python.exe" -m pip install gradio pillow --no-warn-script-location
        
        # éªŒè¯å®‰è£…
        echo "=== Python ç¯å¢ƒéªŒè¯ ==="
        & "å‰ç½®/python-3.12.10-embed-amd64/python.exe" --version
        & "å‰ç½®/python-3.12.10-embed-amd64/python.exe" -c "import gradio; print(f'Gradio version: {gradio.__version__}')"
        & "å‰ç½®/python-3.12.10-embed-amd64/python.exe" -c "import numpy; print(f'NumPy version: {numpy.__version__}')"
        
        # æ˜¾ç¤º pth æ–‡ä»¶å†…å®¹
        echo "=== python312._pth å†…å®¹ ==="
        Get-Content $pthFile
    
    - name: Verify source files exist
      shell: pwsh
      run: |
        echo "=== éªŒè¯æºæ–‡ä»¶ ==="
        $requiredFiles = @("AIS.py", "AIS_WebUI.py", "i18n.py", "requirements.txt", "å¯åŠ¨.bat")
        foreach ($file in $requiredFiles) {
          if (Test-Path $file) {
            echo "âœ“ $file exists"
          } else {
            echo "âœ— $file NOT FOUND!"
            exit 1
          }
        }
        echo "=== æ‰€æœ‰å¿…éœ€æ–‡ä»¶å·²ç¡®è®¤ ==="
    
    - name: Create Lite package
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $packageName = "AIS-$version-Lite"
        
        New-Item -ItemType Directory -Force -Path $packageName
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶å¹¶éªŒè¯
        $coreFiles = @("AIS.py", "AIS_WebUI.py", "i18n.py", "requirements.txt", "å¯åŠ¨.bat")
        foreach ($file in $coreFiles) {
          Copy-Item $file -Destination $packageName -ErrorAction Stop
          echo "Copied: $file"
        }
        
        # å¤åˆ¶å¯é€‰æ–‡ä»¶
        Copy-Item "README.md" -Destination $packageName -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" -Destination $packageName -ErrorAction SilentlyContinue
        
        Copy-Item -Path "æ¨¡å‹" -Destination $packageName -Recurse
        
        New-Item -ItemType Directory -Force -Path "$packageName/è¾“å‡º"
        New-Item -ItemType Directory -Force -Path "$packageName/æ•°æ®"
        
        # éªŒè¯æ‰“åŒ…å†…å®¹
        echo "=== Lite package contents ==="
        Get-ChildItem -Path $packageName -Recurse -Depth 1 | ForEach-Object { Write-Host $_.FullName }
        
        Compress-Archive -Path $packageName -DestinationPath "$packageName.zip" -Force
        echo "Created: $packageName.zip"
    
    - name: Create Full package
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $packageName = "AIS-$version-Full"
        
        New-Item -ItemType Directory -Force -Path $packageName
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶å¹¶éªŒè¯
        $coreFiles = @("AIS.py", "AIS_WebUI.py", "i18n.py", "requirements.txt", "å¯åŠ¨.bat")
        foreach ($file in $coreFiles) {
          Copy-Item $file -Destination $packageName -ErrorAction Stop
          echo "Copied: $file"
        }
        
        # å¤åˆ¶å¯é€‰æ–‡ä»¶
        Copy-Item "README.md" -Destination $packageName -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" -Destination $packageName -ErrorAction SilentlyContinue
        
        Copy-Item -Path "æ¨¡å‹" -Destination $packageName -Recurse
        Copy-Item -Path "å‰ç½®" -Destination $packageName -Recurse
        
        New-Item -ItemType Directory -Force -Path "$packageName/è¾“å‡º"
        New-Item -ItemType Directory -Force -Path "$packageName/æ•°æ®"
        
        # éªŒè¯æ‰“åŒ…å†…å®¹
        echo "=== Full package contents ==="
        Get-ChildItem -Path $packageName -Recurse -Depth 1 | ForEach-Object { Write-Host $_.FullName }
        
        # ç¡®è®¤ i18n.py å­˜åœ¨
        if (-not (Test-Path "$packageName/i18n.py")) {
          echo "ERROR: i18n.py not found in package!"
          exit 1
        }
        
        Compress-Archive -Path $packageName -DestinationPath "$packageName.zip" -Force
        echo "Created: $packageName.zip"
    
    - name: List and verify zip files
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        echo "=== éªŒè¯æ‰“åŒ…æ–‡ä»¶ ==="
        Get-ChildItem -Path "." -Filter "*.zip" | ForEach-Object { 
          Write-Host "$($_.Name) - $([math]::Round($_.Length / 1MB, 2)) MB"
        }
        
        $fullZip = "AIS-$version-Full.zip"
        $liteZip = "AIS-$version-Lite.zip"
        
        if (-not (Test-Path $fullZip)) {
          Write-Error "Full package not found: $fullZip"
          exit 1
        }
        if (-not (Test-Path $liteZip)) {
          Write-Error "Lite package not found: $liteZip"
          exit 1
        }
        
        echo "Both packages verified successfully!"
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: AIS ${{ steps.version.outputs.VERSION }}
        tag_name: ${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: false
        files: |
          AIS-${{ steps.version.outputs.VERSION }}-Full.zip
          AIS-${{ steps.version.outputs.VERSION }}-Lite.zip
        body: |
          ## AIS å›¾åƒè¶…åˆ†è¾¨ç‡å·¥å…· ${{ steps.version.outputs.VERSION }}
          
          ### ğŸ“¦ ä¸‹è½½ç‰ˆæœ¬è¯´æ˜
          
          | ç‰ˆæœ¬ | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|------|
          | **å®Œæ•´ç‰ˆ (æ¨è)** | `AIS-${{ steps.version.outputs.VERSION }}-Full.zip` | å†…ç½® Python 3.12 + Gradioï¼Œå¼€ç®±å³ç”¨ |
          | **ç²¾ç®€ç‰ˆ** | `AIS-${{ steps.version.outputs.VERSION }}-Lite.zip` | éœ€è‡ªè¡Œå®‰è£… Python 3.10+ å’Œä¾èµ– |
          
          ### ğŸ¯ åŒ…å«å¼•æ“
          - **Real-CUGAN** - åŠ¨æ¼«å›¾åƒè¶…åˆ†ï¼Œç»†èŠ‚ä¿ç•™å‡ºè‰²
          - **Real-ESRGAN** - é€šç”¨å›¾åƒè¶…åˆ†ï¼Œæ•ˆæœç¨³å®š
          - **Waifu2x** - ç»å…¸åŠ¨æ¼«è¶…åˆ†ï¼Œé€Ÿåº¦å¿«
          
          ---
          
          ### ğŸš€ å®Œæ•´ç‰ˆä½¿ç”¨æ–¹æ³•
          1. è§£å‹ç¼©åˆ°ä»»æ„ç›®å½•ï¼ˆè·¯å¾„ä¸è¦æœ‰ä¸­æ–‡ï¼‰
          2. åŒå‡» `å¯åŠ¨.bat` è¿è¡Œ
          3. æµè§ˆå™¨è®¿é—® http://127.0.0.1:7860
          
          ### ğŸ”§ ç²¾ç®€ç‰ˆä½¿ç”¨æ–¹æ³•
          1. ç¡®ä¿å·²å®‰è£… Python 3.10 æˆ–æ›´é«˜ç‰ˆæœ¬
          2. è§£å‹ç¼©åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `pip install -r requirements.txt` å®‰è£…ä¾èµ–
          4. åŒå‡» `å¯åŠ¨.bat` è¿è¡Œ
          
          ---
          
          ### âš ï¸ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 x64
          - æ”¯æŒ Vulkan çš„æ˜¾å¡ (NVIDIA/AMD/Intel)
          
          ### ğŸŒ è¯­è¨€æ”¯æŒ
          - ç®€ä½“ä¸­æ–‡ / English
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
